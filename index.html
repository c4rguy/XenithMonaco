<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
    <style type="text/css">
        html,
        body {
            background: #0c0c0f;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: consolas, "poppins", monospace;
            color: white;
            display: flex;
            flex-direction: column;
        }
      #container {
        transition: opacity 0.15s ease-out;
        will-change: opacity;
      }
      .controls {
        background-color: #00000000;
        position: fixed;
        bottom: 20px;
        left: 20px;
        border-radius: 10px;
        padding: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        gap: 5px;
        z-index: 1000;
      }
      .controls button {
        background-color: #00000000;
        border: none;
        border-radius: 5px;
        padding: 0;
        height: 40px;
        width: 40px;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .controls button svg {
        fill: #dddddd;
        transition: fill 0.2s ease;
        width: 22px;
        height: 22px;
      }
      #attach-btn svg {
        transform: scale(1.2);
      }
      .controls button svg:hover {
        fill: #999999;
        transition: fill 0.2s ease;
      }
      .ripple {
        position: absolute;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        transform: scale(0);
        animation: ripple-animation 0.6s linear;
        pointer-events: none;
        clip-path: inset(0 0 0 0 round 5px);
      }
      @keyframes ripple-animation {
        to {
          transform: scale(2.5);
          opacity: 0;
        }
      }
      .toast-container {
        position: fixed;
        bottom: 10px;
        right: 10px;
        z-index: 9999;
      }
      .toast {
        padding: 12px 16px;
        margin: 8px;
        border-radius: 6px;
        color: white;
        font-family: "Inter", sans-serif;
        font-size: 11px;
        opacity: 0;
        transform: translateX(50px);
        filter: blur(8px);
        transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        position: relative;
        max-width: 180px; 
        width: fit-content; 
        white-space: normal; 
        max-height: 100px;
      }
      .toast.error::before {
        content: "";
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
      }
      .toast.success::before {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z'/%3E%3C/svg%3E");
      }

      .toast.success {
        background-color: rgba(34, 197, 94, 0.9);
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
      }
      .toast.error {
        background-color: rgba(239, 68, 68, 0.9);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
      }
      .toast.show {
        opacity: 1;
        transform: translateX(0);
        filter: blur(0);
      }
      .toast.hide {
        opacity: 0;
        transform: translateX(50px);
        filter: blur(8px);
      }

      .toast .toast-title {
        font-weight: 600;
        margin-bottom: 6px;
        color: #fff;
      }

      .toast .toast-code {
        background: rgba(0,0,0,0.3);
        border-radius: 4px;
        font-family: "JetBrains Mono", monospace;
        font-size: 8px;
        padding: 6px 8px;
        white-space: pre;     
        overflow-x: auto;      
        max-height: 160px;      
        overflow-y: auto;     
      }

      .margin:first-child {
        background-image: var(--url);
        background-size: cover;
        background-repeat: no-repeat;
        background-attachment: fixed;
      }
      .lines-content:nth-of-type(1),
      .monaco-editor-background:nth-of-type(1) {
        background-image: var(--url);
        background-size: cover;
        background-repeat: no-repeat;
        background-attachment: fixed;
      }
      #main-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        width: 100vw;
      }
    </style>
    <meta charset="utf-8" />
    <title></title>
  </head>
  <body>
    <div id="main-container">
      <div class="toast-container"></div>
      <div id="container" style="width: 100%; height: 100%"></div>
    </div>
    <script src="https://unpkg.com/luaparse@0.3.1/luaparse.js"></script>
    <script src="vs/loader.js"></script>
    <script type="text/javascript">
      window.addEventListener("load", function () {

      });
      
      require.config({
        paths: {
          vs: "vs",
        },
      });
      var GetText;
      var SetText;
      var SetTheme;
      var SetScroll;
      var ShowError;
      var Refresh;
      var SwitchMinimap;
      var SwitchReadonly;
      var SwitchRenderWhitespace;
      var SwitchLinks;
      var SwitchLineHeight;
      var SwitchFontSize;
      var SwitchFolding;
      var SwitchAutoIndent;
      var SwitchFontFamily;
      var SwitchFontLigatures;
      var AddIntellisense;
      var editor;
      var Proposals = [];
      require(["vs/editor/editor.main"], function () {
        function getDependencyProposals() {
          let newProposals = [];
          for (let index = 0; index < Proposals.length; index++) {
            const element = Proposals[index];
            let newElement = {};
            for (const key in element) {
              if (key == "__children__") {
                continue;
              }
              newElement[key] = element[key];
            }
            newProposals.push(newElement);
          }
          return newProposals;
        }
          monaco.editor.defineTheme("Strace", {
          base: "vs-dark",
          inherit: true,
          rules: [
            { token: "keyword", foreground: "#D16969", fontStyle: "bold" },
            { token: "keyword.control", foreground: "#D16969", fontStyle: "bold" },
            { token: "keyword.operator", foreground: "#D16969" },
            { token: "keyword.local", foreground: "#D16969", fontStyle: "bold" },
            { token: "keyword.other", foreground: "#D16969", fontStyle: "bold" },

            { token: "entity.name.function", foreground: "#CE9178", fontStyle: "bold" },
            { token: "support.function", foreground: "#CE9178", fontStyle: "bold" },
            { token: "support.function.library", foreground: "#CE9178", fontStyle: "bold" },
            { token: "function", foreground: "#CE9178", fontStyle: "bold" },
            { token: "function.call", foreground: "#CE9178" },

            { token: "variable", foreground: "#D4D4D4" },
            { token: "variable.language.self", foreground: "#D16969", fontStyle: "bold" },
            { token: "variable.parameter.function", foreground: "#D4D4D4" },
            { token: "variable.other.constant", foreground: "#D16969" },
            { token: "variable.property", foreground: "#D4D4D4" },
            { token: "variable.object.property", foreground: "#D4D4D4" },

            { token: "string", foreground: "#CE9178" },
            { token: "string.escape", foreground: "#CE9178", fontStyle: "bold" },

            { token: "number", foreground: "#D16969", fontStyle: "bold" },
            { token: "constant.language", foreground: "#D16969", fontStyle: "bold" },
            { token: "constants", foreground: "#D16969", fontStyle: "bold" },

            { token: "storage.type", foreground: "#CE9178", fontStyle: "bold" },
            { token: "entity.name.type.alias", foreground: "#CE9178", fontStyle: "bold" },
            { token: "support.type", foreground: "#CE9178", fontStyle: "bold" },
            { token: "type", foreground: "#CE9178", fontStyle: "bold" },

            { token: "delimiter", foreground: "#8a6e6e" },
            { token: "delimiter.bracket", foreground: "#8a6e6e" },
            { token: "delimiter.array", foreground: "#8a6e6e" },
            { token: "delimiter.parenthesis", foreground: "#8a6e6e" },
            { token: "punctuation.separator.arguments", foreground: "#8a6e6e" },
            { token: "punctuation.separator.parameter", foreground: "#8a6e6e" },
            { token: "punctuation.definition.block", foreground: "#8a6e6e" },
            { token: "punctuation.definition.parameters", foreground: "#8a6e6e" },

            { token: "comment", foreground: "#8a6e6e" },
            { token: "comment.highlight.title", foreground: "#8a6e6e", fontStyle: "italic" },
          ],
          colors: {
            "editor.background": "#00000000",
            "editor.foreground": "#ffffff",
            "editorLineNumber.foreground": "#3a3a3a",
            "editorLineNumber.activeForeground": "#ffffff",
            "editor.lineHighlightBackground": "#00000000",
            "editor.lineHighlightBorder": "#232323",
            "editorIndentGuide.background": "#252525",
            "editorIndentGuide.activeBackground": "#ffffff50",
            "editorCursor.foreground": "#ffffff",
            "editor.selectionBackground": "#ffffff30",
            "editor.selectionHighlightBackground": "#ffffff20",
            "editor.wordHighlightBackground": "#ffffff18",
            "editor.wordHighlightStrongBackground": "#ffffff25",
            "editor.findMatchBackground": "#ffffff35",
            "editor.findMatchHighlightBackground": "#ffffff20",
            "editorSuggestWidget.background": "#212121",
            "editorSuggestWidget.border": "#2a2a2a",
            "editorSuggestWidget.foreground": "#ffffff",
            "editorSuggestWidget.selectedBackground": "#ffffff25",
            "editorSuggestWidget.highlightForeground": "#ffffff",
            "editorBracketHighlight.foreground1": "#ffffff",
            "editorBracketHighlight.foreground2": "#ffffff",
            "editorBracketHighlight.foreground3": "#ffffff",
            "editorGutter.background": "#00000000",
            "editorGutter.modifiedBackground": "#ffffff50",
            "editorGutter.addedBackground": "#ffffff30",
            "editorGutter.deletedBackground": "#ffffff30",
            "scrollbarSlider.background": "#ffffff20",
            "scrollbarSlider.hoverBackground": "#ffffff30",
            "scrollbarSlider.activeBackground": "#ffffff40",
            "minimap.background": "#0c0c0f",
            "minimap.selectionHighlight": "#1e1e1e",
          },
        });
require(["vs/basic-languages/monaco.contribution"], function () {
          monaco.languages.registerCompletionItemProvider("lua", {
            provideCompletionItems: function (model, position) {
              return {
                suggestions: getDependencyProposals(),
              };
            },
            triggerCharacters: [".", ":", '"'],
          });
          editor = monaco.editor.create(document.getElementById("container"), {
            value:
              "--[[\n    Welcome to Xenith\n    Made by c4rguy\n ]]",
            language: "lua",
            theme: "Strace",
            folding: true,
            dragAndDrop: true,
            links: true,
            minimap: {
              enabled: true,
            },
            showFoldingControls: "always",
            smoothScrolling: true,
            stopRenderingLineAfter: 6500,
            fontSize: 12,
            fontFamily: "cascadia mono",
            cursorBlinking: "smooth",
            cursorSmoothCaretAnimation: true,
            foldingHighlight: false,
            fontLigatures: true,
            formatOnPaste: true,
            showDeprecated: true,
            suggest: {
              snippetsPreventQuickSuggestions: false,
            },
            lineNumbersMinChars: 3,
          });
          editor.getModel().updateOptions({ insertSpaces: false });

          const debouncedCheck = debounce(validateLuaCode, 400);

          editor.onDidChangeModelContent(() => {
            debouncedCheck();
          });

          setTimeout(validateLuaCode, 500);

        });
        
        window.onresize = function () {
          editor.layout();
        };
        Cut = function () {
          editor.focus();
          document.execCommand("cut");
        };
        Copy = function () {
          editor.focus();
          document.execCommand("copy");
        };
        Paste = function () {
          editor.focus();
          document.execCommand("paste");
        };
        Undo = function () {
          editor.focus();
          document.execCommand("undo");
        };
        Redo = function () {
          editor.focus();
          document.execCommand("redo");
        };
        Delete = function () {
          editor.focus();
          document.execCommand("delete");
        };
        SelectAll = function () {
          editor.focus();
          document.execCommand("selectAll");
        };
        GetText = function () {
          return editor.getValue();
        };
        SetText = function (x) {
          editor.setValue(x);
        };
        GetProposals = function () {
          return Proposals;
        };
        OnDidChangeContent = function (callback) {
          return editor.onDidChangeModelContent((event) => {
            callback(editor.getValue());
          });
        };
        OnDidChangeCursorPosition = function (callback) {
          return editor.onDidChangeCursorPosition((event) => {
            callback(event.position);
          });
        };
        SetTheme = function (themeName) {
          if (themeName == "Dark") {
            monaco.editor.setTheme("Dark");
          }
        };
        SwitchMinimap = function (flag) {
          editor.updateOptions({
            minimap: {
              enabled: flag,
            },
          });
        };
        SwitchReadonly = function (flag) {
          editor.updateOptions({
            readOnly: flag,
          });
        };
        SwitchRenderWhitespace = function (op) {
          editor.updateOptions({
            renderWhitespace: op,
          });
        };
        SwitchLinks = function (flag) {
          editor.updateOptions({
            links: flag,
          });
        };
        SwitchLineHeight = function (num) {
          editor.updateOptions({
            lineHeight: num,
          });
        };
        SwitchFontSize = function (num) {
          editor.updateOptions({
            fontSize: num,
          });
        };
        SwitchFolding = function (flag) {
          editor.updateOptions({
            folding: flag,
          });
        };
        SwitchAutoIndent = function (flag) {
          editor.updateOptions({
            autoIndent: flag,
          });
        };
        SwitchFontFamily = function (name) {
          editor.updateOptions({
            fontFamily: name,
          });
        };
        SwitchFontLigatures = function (flag) {
          editor.updateOptions({
            fontLigatures: flag,
          });
        };
        AddSnippet = function (kindName, snippetName, data) {
          let snippet = {
            insertTextRules:
              monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
            kind: monaco.languages.CompletionItemKind[kindName],
          };
          for (const key in data) {
            let value = data[key];
            if (key == "insertText" && typeof value == "object") {
              value = value.join("\n");
            }
            snippet[key] = value;
          }
          if (!snippet.label) {
            snippet.label = snippetName;
          }
          if (!snippet.insertText) {
            snippet.insertText = snippetName;
          }
          Proposals.push(snippet);
        };
        AddRawSnippet = function (data) {
          Proposals.push(data);
        };
        SetScroll = function (line) {
          editor.revealLineInCenter({ lineNumber: line });
        };
        Refresh = function () {
          var Text = GetText();
          SetText(Text);
          editor.trigger("keyboard", "type", { text: Text });
        };
        AddIntellisense = function (l, k, d, i) {
          console.log(l);
          console.log(k);
          console.log(d);
          console.log(i);
          var t;
          switch (k) {
            case "Class":
              t = monaco.languages.CompletionItemKind.Class;
              break;
            case "Color":
              t = monaco.languages.CompletionItemKind.Color;
              break;
            case "Constructor":
              t = monaco.languages.CompletionItemKind.Constructor;
              break;
            case "Enum":
              t = monaco.languages.CompletionItemKind.Enum;
              break;
            case "Field":
              t = monaco.languages.CompletionItemKind.Field;
              break;
            case "File":
              t = monaco.languages.CompletionItemKind.File;
              break;
            case "Folder":
              t = monaco.languages.CompletionItemKind.Folder;
              break;
            case "Function":
              t = monaco.languages.CompletionItemKind.Function;
              break;
            case "Interface":
              t = monaco.languages.CompletionItemKind.Interface;
              break;
            case "Keyword":
              t = monaco.languages.CompletionItemKind.Keyword;
              break;
            case "Method":
              t = monaco.languages.CompletionItemKind.Method;
              break;
            case "Module":
              t = monaco.languages.CompletionItemKind.Module;
              break;
            case "Property":
              t = monaco.languages.CompletionItemKind.Property;
              break;
            case "Reference":
              t = monaco.languages.CompletionItemKind.Reference;
              break;
            case "Snippet":
              t = monaco.languages.CompletionItemKind.Snippet;
              break;
            case "Text":
              t = monaco.languages.CompletionItemKind.Text;
              break;
            case "Unit":
              t = monaco.languages.CompletionItemKind.Unit;
              break;
            case "Value":
              t = monaco.languages.CompletionItemKind.Value;
              break;
            case "Variable":
              t = monaco.languages.CompletionItemKind.Variable;
              break;
          }
          document.getElementsByClassName(
            "lines-content monaco-editor-background"
          )[0].style.backgroundImage =
            "url(https://c.tenor.com/StDUfEak8SkAAAAC/tenor.gif)";
          document.getElementsByClassName("margin")[0].style.backgroundImage =
            "url(https://c.tenor.com/StDUfEak8SkAAAAC/tenor.gif)";
          Proposals.push({
            label: l,
            kind: t,
            detail: d,
            insertText: i,
          });
          console.log(Proposals);
        };
      });

    function showPersistentToast(message, type, codePreview = null) {
      const container = document.querySelector(".toast-container");
      let existingToast = container.querySelector(".toast");
      if (!existingToast) {
        existingToast = document.createElement("div");
        existingToast.className = `toast ${type} show`;
        container.appendChild(existingToast);
      }

      existingToast.innerHTML = `
        <div class="toast-title">${message}</div>
        ${codePreview ? `<pre class="toast-code">${codePreview}</pre>` : ""}
      `;
    }


    function clearPersistentToast() {
      const container = document.querySelector(".toast-container");
      const toast = container.querySelector(".toast");
      if (toast) {
        toast.remove();
      }
    }

    function debounce(fn, wait) {
      let t = null;
      return function () {
        const args = arguments;
        clearTimeout(t);
        t = setTimeout(function () {
          fn.apply(null, args);
        }, wait);
      };
    }

    function validateLuaCode() {
      const model = editor.getModel();
      if (!model) return;

      const code = model.getValue();
      let markers = [];

      try {
        luaparse.parse(code, {
          wait: false,
          comments: false,
          locations: true
        });
      } catch (err) {
        if (err && err.line) {
          const lineContent = model.getLineContent(err.line);
          markers.push({
            severity: monaco.MarkerSeverity.Error,
            message: err.message,
            startLineNumber: err.line,
            startColumn: err.column || 1,
            endLineNumber: err.line,
            endColumn: (err.column || 1) + 1
          });

          const errorTitle = `Syntax Error at line ${err.line}, col ${err.column || 1}: ${err.message}`;
          const preview = lineContent.trim().slice(0, 80);

          window.chrome.webview.postMessage({
            type: "luaError",
            title: errorTitle,
            preview: preview
          });
        }
      }

      monaco.editor.setModelMarkers(model, "luaparse", markers);


      if (markers.length === 0) {
        window.chrome.webview.postMessage({
          type: "clearErrors"
        });
      }
    }
    </script>

    <script src="script.js"></script>
  </body>
</html>
