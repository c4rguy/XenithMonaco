var monacopilot=(function(exports){'use strict';var ue=`

`;var $=["mistral"],Ce={codestral:"codestral-latest"},U={mistral:["codestral"]},ge={mistral:"https://api.mistral.ai/v1/fim/completions"},fe=class{},he=class extends fe{createEndpoint(){return ge.mistral}createRequestBody(t,e,o){return {model:Ce[t],prompt:`${e.context}
${e.instruction}
${o.textBeforeCursor}`,suffix:o.textAfterCursor,stream:false,top_p:.1,temperature:.1,stop:ue,max_tokens:256}}createHeaders(t){return {"Content-Type":"application/json",Authorization:`Bearer ${t}`}}parseCompletion(t){let e=t.choices?.[0]?.message.content;return e?Array.isArray(e)?e.filter(o=>"text"in o).map(o=>o.text).join(""):e:null}},P={mistral:new he},Ee=(t,e,o)=>P[o].createEndpoint(t,e),ye=(t,e,o,r)=>P[e].createRequestBody(t,o,r),Re=(t,e)=>P[e].createHeaders(t),xe=(t,e)=>P[e].parseCompletion(t),S="\x1B[0m",F="\x1B[1m",H=t=>t instanceof Error?t.message:typeof t=="string"?t:"An unknown error occurred",ve=t=>{let e=H(t),o=`${F}[MONACOPILOT ERROR] ${e}${S}`;return console.error(o),{message:e}},Pe=(t,e)=>{console.warn(`${F}[MONACOPILOT WARN] ${t}${e?`
${H(e)}`:""}${S}`);},Te=(t,e,o)=>console.warn(`${F}[MONACOPILOT DEPRECATED] "${t}" is deprecated${o?` in ${o}`:""}. Please use "${e}" instead. It will be removed in a future version.${S}`),f={report:ve,warn:Pe,warnDeprecated:Te},be=async(t,e={},o=2e4)=>{let r=new AbortController,{signal:n}=r,i=setTimeout(()=>{r.abort();},o);try{return await fetch(t,{...e,signal:n})}catch(s){throw s instanceof DOMException&&s.name==="AbortError"?new Error(`Request timed out after ${o}ms`):s}finally{clearTimeout(i);}},j=t=>!t||t.length===0?"":t.length===1?t[0]:`${t.slice(0,-1).join(", ")} and ${t.slice(-1)}`,Oe=(t,e)=>{if(!t&&typeof e.model!="function")throw new Error(e.provider?`Please provide the ${e.provider} API key.`:"Please provide an API key.");if(!e||typeof e=="object"&&Object.keys(e).length===0)throw new Error('Please provide required Copilot options, such as "model" and "provider".')},Ie=(t,e)=>{if(typeof t=="function"&&e!==void 0)throw new Error("Provider should not be specified when using a custom model.");if(typeof t!="function"&&(!e||!$.includes(e)))throw new Error(`Provider must be specified and supported when using built-in models. Please choose from: ${j($)}`);if(typeof t=="string"&&e!==void 0&&!U[e].includes(t))throw new Error(`Model "${t}" is not supported by the "${e}" provider. Supported models: ${j(U[e])}`)},K={params:Oe,inputs:Ie},V=class{constructor(t,e){K.params(t,e),this.apiKey=t??"",this.provider=e.provider,this.model=e.model,K.inputs(this.model,this.provider);}generatePrompt(t,e){let o=this.getDefaultPrompt(t);return e?{...o,...e(t)}:o}async makeAIRequest(t,e={}){try{let o=this.generatePrompt(t,e.customPrompt);if(this.isCustomModel())return this.model(o);{let{aiRequestHandler:r}=e,n=await this.prepareRequest(o,t),i=await this.sendRequest(n.endpoint,n.requestBody,n.headers,r);return this.processResponse(i)}}catch(o){return this.handleError(o)}}async prepareRequest(t,e){if(!this.provider)throw new Error("Provider is required for non-custom models");return {endpoint:Ee(this.model,this.apiKey,this.provider),headers:Re(this.apiKey,this.provider),requestBody:ye(this.model,this.provider,t,e)}}processResponse(t){if(!this.provider)throw new Error("Provider is required for non-custom models");return {text:xe(t,this.provider),raw:t}}isCustomModel(){return typeof this.model=="function"}async sendRequest(t,e,o,r){let n={"Content-Type":"application/json",...o};if(r)return r({endpoint:t,body:e,headers:n});let i=await be(t,{method:"POST",headers:n,body:JSON.stringify(e)});if(!i.ok)throw new Error(await i.text());return i.json()}handleError(t){return {text:null,error:f.report(t).message}}};var W=t=>!t||t.length===0?"":t.length===1?t[0]:`${t.slice(0,-1).join(", ")} and ${t.slice(-1)}`;var N=(t,e,o={})=>{if(e<=0)return "";let r=t.split(`
`),n=r.length;if(e>=n)return t;if(o.truncateDirection==="keepEnd"){let s=r.slice(-e);return s.every(l=>l==="")?`
`.repeat(e):s.join(`
`)}let i=r.slice(0,e);return i.every(s=>s==="")?`
`.repeat(e):i.join(`
`)};var Me="<|developer_cursor_is_here|>",z=t=>({instruction:Le(),context:Ae(t),fileContent:we(t)}),Le=()=>"Provide concise and readable code completions that are syntactically and logically accurate, and seamlessly integrate with the existing context. Output only the raw code to be inserted at the cursor location without any additional text, comments, or text before or after the cursor.",Ae=t=>{let{technologies:e=[],filename:o,relatedFiles:r=[],language:n}=t,i=W([n,...e].filter(a=>!!a)),s=r.length===0?"":r.map(({path:a,content:p})=>`### ${a}
${p}`).join(`

`),l=[i?`Technology stack: ${i}`:"",`File: ${o||"unknown"}`].filter(Boolean).join(`
`);return `${s?`${s}

`:""}${l}`},we=t=>{let{textBeforeCursor:e,textAfterCursor:o}=t;return `**Current code:**
\`\`\`
${e}${Me}${o}
\`\`\``};var T=class extends V{async complete(e){let{body:o,options:r}=e,{customPrompt:n,aiRequestHandler:i}=r??{},{completionMetadata:s}=o,{text:l,raw:a,error:p}=await this.makeAIRequest(s,{customPrompt:n,aiRequestHandler:i});return {completion:l,raw:a,error:p}}getDefaultPrompt(e){return z(e)}};var X=100,Y=true,b="onIdle",J=true,Q=120,Z=400,ee=0;var h=(t,e)=>e.getValueInRange({startLineNumber:1,startColumn:1,endLineNumber:t.lineNumber,endColumn:t.column}),te=(t,e)=>e.getValueInRange({startLineNumber:t.lineNumber,startColumn:t.column,endLineNumber:e.getLineCount(),endColumn:e.getLineMaxColumn(e.getLineCount())}),oe=t=>t.getValue();var O=class{constructor(e){this.capacity=e;this.head=0;this.tail=0;this.size=0;this.buffer=new Array(e);}enqueue(e){let o;return this.size===this.capacity&&(o=this.dequeue()),this.buffer[this.tail]=e,this.tail=(this.tail+1)%this.capacity,this.size++,o}dequeue(){if(this.size===0)return;let e=this.buffer[this.head];return this.buffer[this.head]=void 0,this.head=(this.head+1)%this.capacity,this.size--,e}getAll(){return this.buffer.filter(e=>e!==void 0)}clear(){this.buffer=new Array(this.capacity),this.head=0,this.tail=0,this.size=0;}getSize(){return this.size}isEmpty(){return this.size===0}isFull(){return this.size===this.capacity}};var M=class M{constructor(){this.cache=new O(M.MAX_CACHE_SIZE);}get(e,o){return this.cache.getAll().filter(r=>this.isValidCacheItem(r,e,o))}add(e){e.completion.trim()&&this.cache.enqueue(e);}clear(){this.cache.clear();}isValidCacheItem(e,o,r){let n=e.textBeforeCursor.trim(),i=h(o,r),s=i,l=r.getLineContent(o.lineNumber);if(o.column===l.length+1&&o.lineNumber<r.getLineCount()){let p=r.getLineContent(o.lineNumber+1);s=`${i}
${p}`;}if(!(s.trim().includes(n)||n.includes(s.trim())))return  false;let a=r.getValueInRange(e.range);return this.isPartialMatch(a,e.completion)?this.isPositionValid(e,o):false}isPartialMatch(e,o){let r=e.trim(),n=o.trim();return n.startsWith(r)||r.startsWith(n)}isPositionValid(e,o){let{range:r}=e,{startLineNumber:n,startColumn:i,endLineNumber:s,endColumn:l}=r,{lineNumber:a,column:p}=o;return a<n||a>s?false:n===s?p>=i-1&&p<=l+1:a===n?p>=i-1:a===s?p<=l+1:true}};M.MAX_CACHE_SIZE=20;var I=M;var L=class{constructor(e){this.formattedCompletion="";this.formattedCompletion=e;}setCompletion(e){return this.formattedCompletion=e,this}removeInvalidLineBreaks(){return this.formattedCompletion=this.formattedCompletion.trimEnd(),this}removeMarkdownCodeSyntax(){return this.formattedCompletion=this.removeMarkdownCodeBlocks(this.formattedCompletion),this}removeMarkdownCodeBlocks(e){let o=e.split(`
`),r=[],n=false;for(let i=0;i<o.length;i++){let s=o[i],l=s.trim().startsWith("```");if(l&&!n){n=true;continue}if(l&&n){n=false;continue}r.push(s);}return r.join(`
`)}removeExcessiveNewlines(){return this.formattedCompletion=this.formattedCompletion.replace(/\n{3,}/g,`

`),this}build(){return this.formattedCompletion}};var A=class{findOverlaps(e,o,r){if(!e)return {startOverlapLength:0,maxOverlapLength:0};let n=e.length,i=o.length,s=r.length,l=0,a=0,p=0,d=Math.min(n,i);for(let m=1;m<=d;m++){let u=e.substring(0,m),C=o.slice(-m);u===C&&(p=m);}let c=Math.min(n,s);for(let m=0;m<c&&e[m]===r[m];m++)l++;for(let m=1;m<=c;m++)e.slice(-m)===r.slice(0,m)&&(a=m);let g=Math.max(l,a);if(g===0){for(let m=1;m<n;m++)if(r.startsWith(e.substring(m))){g=n-m;break}}return {startOverlapLength:p,maxOverlapLength:g}}};var w=class{constructor(e){this.monaco=e;this.textOverlapCalculator=new A;}computeInsertionRange(e,o,r){if(!o)return this.createEmptyRange(e);let n=r.getOffsetAt(e),i=r.getValue().substring(0,n),s=r.getValue().substring(n);if(n>=r.getValue().length)return this.createEmptyRange(e);if(s.length===0)return this.createEmptyRange(e);let{startOverlapLength:l,maxOverlapLength:a}=this.textOverlapCalculator.findOverlaps(o,i,s),p=l>0?r.getPositionAt(n-l):e,d=n+a,c=r.getPositionAt(d);return new this.monaco.Range(p.lineNumber,p.column,c.lineNumber,c.column)}computeCacheRange(e,o){let r=e.lineNumber,n=e.column,i=o.split(`
`),s=i.length-1,l=r+s,a=s===0?n+i[0].length:i[s].length+1;return new this.monaco.Range(r,n,l,a)}createEmptyRange(e){return new this.monaco.Range(e.lineNumber,e.column,e.lineNumber,e.column)}};var re=async t=>{let{endpoint:e,body:o}=t,r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!r.ok)throw new Error(`Error while fetching completion item: ${r.statusText}`);let{completion:n,error:i}=await r.json();return {completion:n,error:i}},ne=({pos:t,mdl:e,options:o})=>{let{filename:r,language:n,technologies:i,relatedFiles:s,maxContextLines:l=X}=o,p=s&&s.length>0?3:2,d=l?Math.floor(l/p):void 0,c=(R,x,_)=>{let v=R(t,e);return x?N(v,x,_):v},g=(R,x)=>!R||!x?R:R.map(({content:_,...v})=>({...v,content:N(_,x)})),m=c(h,d,{truncateDirection:"keepEnd"}),u=c(te,d,{truncateDirection:"keepStart"}),C=g(s,d);return {filename:r,language:n,technologies:i,relatedFiles:C,textBeforeCursor:m,textAfterCursor:u,cursorPosition:t}};var ie=(t,e=300)=>{let o=null,r=null,n=(...i)=>{if(r)return r.args=i,r.promise;let s,l,a=new Promise((p,d)=>{s=p,l=d;});return r={args:i,promise:a,resolve:s,reject:l},o&&(clearTimeout(o),o=null),o=setTimeout(async()=>{let p=r;if(p){r=null,o=null;try{let d=await t(...p.args);p.resolve(d);}catch(d){p.reject(d);}}},e),a};return n.cancel=()=>{o&&(clearTimeout(o),o=null),r&&(r.reject(new Error("Cancelled")),r=null);},n};var se=t=>typeof t=="string"?t==="Cancelled"||t==="AbortError":t instanceof Error?t.message==="Cancelled"||t.name==="AbortError":false;var E=t=>({items:t,enableForwardStability:true});var D=new I,ae=async({monaco:t,mdl:e,pos:o,token:r,isCompletionAccepted:n,options:i})=>{let{trigger:s=b,enableCaching:l=Y,allowFollowUpCompletions:a=J,onError:p,requestHandler:d}=i;if(l&&!n){let c=D.get(o,e).map(g=>({insertText:g.completion,range:g.range}));if(c.length>0)return E(c)}if(r.isCancellationRequested||!a&&n)return E([]);try{let c=ie(async u=>{i.onCompletionRequested?.(u);let C;if(d)C=await d(u);else if(i.endpoint)C=await re({endpoint:i.endpoint,...u});else throw new Error('No endpoint specified for completion request. Please set the "endpoint" option in registerCompletion, or provide a custom requestHandler.');if(C.error)throw new Error(C.error);return i.onCompletionRequestFinished?.(u,C),C},{onTyping:Q,onIdle:Z,onDemand:ee}[s]);r.onCancellationRequested(()=>{c.cancel();});let g=ne({pos:o,mdl:e,options:i}),{completion:m}=await c({body:{completionMetadata:g}});if(m){let u=new L(m).removeMarkdownCodeSyntax().removeExcessiveNewlines().removeInvalidLineBreaks().build(),C=new w(t);return l&&D.add({completion:u,range:C.computeCacheRange(o,u),textBeforeCursor:h(o,e)}),E([{insertText:u,range:C.computeInsertionRange(o,u,e)}])}}catch(c){if(se(c))return E([]);p?p(c):f.warn("Cannot provide completion",c);}return E([])};var q=new WeakMap,y=t=>q.get(t),le=(t,e)=>{q.set(t,e);},k=t=>{q.delete(t);},pe=t=>({isCompletionAccepted:false,isCompletionVisible:false,isExplicitlyTriggered:false,hasRejectedCurrentCompletion:false,options:t}),me=(t,e)=>{let o=y(t);!o||!o.options||(o.options={...o.options,...e});};var ce=(t,e,o)=>{let r=y(e);return r?t.languages.registerInlineCompletionsProvider(o.language,{provideInlineCompletions:(n,i,s,l)=>{if(n!==e.getModel())return {items:[]};let a=r.options||o;if(!(a.trigger==="onDemand"&&!r.isExplicitlyTriggered||a.triggerIf&&!a.triggerIf({text:oe(e),position:i,triggerType:a.trigger??b})))return ae({monaco:t,mdl:n,pos:i,token:l,isCompletionAccepted:r.isCompletionAccepted,options:a})},handleItemDidShow:(n,i,s)=>{if(r.isExplicitlyTriggered=false,r.hasRejectedCurrentCompletion=false,r.isCompletionAccepted)return;r.isCompletionVisible=true,(r.options||o).onCompletionShown?.(s,i.range);},freeInlineCompletions:()=>{}}):null};var De={TAB:(t,e)=>e.keyCode===t.KeyCode.Tab,CMD_RIGHT_ARROW:(t,e)=>e.keyCode===t.KeyCode.RightArrow&&e.metaKey},B=class{constructor(e,o,r){this.monaco=e;this.state=o;this.initialOptions=r;}handleKeyEvent(e){let o=this.state.options||this.initialOptions,r={monaco:this.monaco,event:e,state:this.state,options:o};this.handleCompletionAcceptance(r),this.handleCompletionRejection(r);}handleCompletionAcceptance(e){return e.state.isCompletionVisible&&this.isAcceptanceKey(e.event)?(e.options.onCompletionAccepted?.(),e.state.isCompletionAccepted=true,e.state.isCompletionVisible=false,true):(e.state.isCompletionAccepted=false,false)}handleCompletionRejection(e){return this.shouldRejectCompletion(e)?(e.options.onCompletionRejected?.(),e.state.hasRejectedCurrentCompletion=true,true):false}shouldRejectCompletion(e){return e.state.isCompletionVisible&&!e.state.hasRejectedCurrentCompletion&&!e.state.isCompletionAccepted&&!this.isAcceptanceKey(e.event)}isAcceptanceKey(e){return Object.values(De).some(o=>o(this.monaco,e))}},de=(t,e,o,r)=>{let n=new B(t,o,r);return e.onKeyDown(i=>n.handleKeyEvent(i))};var _e=(t,e,o)=>{let r=[];le(e,pe(o)),e.updateOptions({inlineSuggest:{enabled:true}});try{let n=y(e);if(!n)return f.warn("Completion is not registered properly. State not found."),Fe();let i=ce(t,e,o);i&&r.push(i);let s=de(t,e,n,o);return r.push(s),{deregister:()=>{for(let a of r)a.dispose();D.clear(),k(e);},trigger:()=>Se(e),updateOptions:a=>{me(e,a(n.options||o));}}}catch(n){return o.onError?o.onError(n):f.report(n),{deregister:()=>{for(let i of r)i.dispose();k(e);},trigger:()=>{},updateOptions:()=>{}}}},Se=t=>{let e=y(t);if(!e){f.warn("Completion is not registered. Use `registerCompletion` to register completion first.");return}e.isExplicitlyTriggered=true,t.trigger("keyboard","editor.action.inlineSuggest.trigger",{});},Fe=()=>({deregister:()=>{},trigger:()=>{},updateOptions:()=>{}});var Bt=T;exports.CompletionCopilot=T;exports.Copilot=Bt;exports.registerCompletion=_e;return exports;})({});